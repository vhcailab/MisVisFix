{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% load crispy_forms_tags %}

{% block title %}
MisVisFix
{% endblock %}

{% block style %}
        .background-container {
            height: 100vh;
            background-image: url('{{ MEDIA_URL }}custom_bkg.jpg');
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .upload-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            width: 100%;
            margin-top: 10px;
        }

        .upload-box {
            border: 1px dashed grey;
            text-align: center;
            border-radius: 10px;
            width: 50%;
            max-width: 700px;
            height: auto;
            min-height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
        }

        .upload-box img {
            max-width: 150px;
            margin-bottom: 20px;
        }

        .llm-selection {
            display: flex;
            justify-content: center;
        }

        .upload-top-info {
            margin-bottom: 20px;
            text-align: center;
        }
        .upload-top-info img{
            width: 70px;
            height: 70px;
        }
        .upload-top-info-text {
            font-size: 1rem;
            color: #ffffff;
            margin-top: 10px;
            font-weight: bold;
        }

        .upload-instructions img{
            width: 100px;
            height: 100px;
        }

        .llm-selection-container {
            margin-top: 20px;
            width: 50%;
            max-width: 700px;
        }

        .llm-selection-title {
            font-size: 16px;
            color: #ffffff;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .llm-selection button {
            font-size: 14px;
            border-radius: 10px;
            flex: 1;
            margin: 0;
            padding: 0;
            font-weight: bold;
            height: 40px;
            background-color: transparent;
            color: white;
            border: 1px solid white;
            transition: all 0.3s ease;
        }

        .llm-selection button.selected {
            background-color: white;
            color: black;
            border-color: white;
        }

        #file-input {
            display: none;
        }

        .loader {
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            margin: -60px 0 0 -60px; /* Position loader in the center */
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }

        .top-buttons {
            position: absolute;
            top: 20px;
            right: 30px;
            display: flex;
            gap: 15px;
            z-index: 1000;
        }

        .nav-button {
            background-color: transparent;
            border: 1px solid #00ffff;
            color: #00ffff;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .nav-button:hover {
            background-color: #00ffff;
            color: #000;
        }

{% endblock %}

{% block content %}
<div class="background-container">
        <div class="upload-top-info">
            <img src="{{ MEDIA_URL }}app-logo.png" alt="Logo">
            <p class="upload-top-info-text">Upload Chart to Start</p>
        </div>
        <div class="upload-container">
            <div class="upload-box" id="upload-box">
                <div class="upload-instructions">
                    <img src="{{ MEDIA_URL }}upload_home_icon.png" alt="Logo" style="margin: 0; padding: 0">
                    <p class="upload-top-info-text" style="margin: 0; padding: 0">Click to Upload</p>
                </div>
            </div>
            <input type="file" id="file-input" accept="image/*">

            <div id="loader" class="loader hidden"></div>

        </div>

        <div class="top-buttons">
            <a href="{% url 'gallery' %}" target="_blank" class="nav-button">
                <i class="fas fa-image"></i> Gallery
            </a>
            <a href="{% url 'how_it_works' %}" target="_blank" class="nav-button">
                <i class="fas fa-info-circle"></i> How It Works
            </a>

            <a href="{% url 'how_to_setup_key' %}" target="_blank" class="nav-button">
                <i class="fas fa-info-circle"></i> API Key Setup Guide
            </a>

            <a href="#" class="nav-button" onclick="showUserConfig()">
                <i class="fas fa-cog"></i> Configuration
            </a>

        </div>

</div>

<!-- Modal Trigger Example -->
<!-- <button class="btn btn-primary" data-toggle="modal" data-target="#userConfigModal">Configure API</button> -->

<!-- Modal -->
<div class="modal fade" id="userConfigModal" tabindex="-1" role="dialog" aria-labelledby="userConfigModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content rounded-lg shadow">
      <div class="modal-header">
        <h5 class="modal-title" id="userConfigModalLabel">API Configuration</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">

        <!-- OpenAI Key -->
        <div class="form-group mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <label for="user-openai-key" class="mb-1 font-weight-bold">OpenAI Key</label>
            <a href="https://platform.openai.com/account/api-keys" target="_blank" title="Get OpenAI API Key">
              <i class="fas fa-link text-primary"></i>
            </a>
          </div>
          <input type="text" class="form-control" id="user-openai-key" placeholder="Enter OpenAI API Key">
        </div>

        <!-- Claude API Key -->
        <div class="form-group mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <label for="user-claude-key" class="mb-1 font-weight-bold">Claude Key</label>
            <a href="https://console.anthropic.com/settings/keys" target="_blank" title="Get Claude API Key">
              <i class="fas fa-link text-primary"></i>
            </a>
          </div>
          <input type="text" class="form-control" id="user-claude-key" placeholder="Enter Claude API Key">
        </div>

        <!-- OpenAI Assistant ID -->
        <div class="form-group mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <label for="open-ai-asst-id" class="mb-1 font-weight-bold">OpenAI Asst. ID</label>
            <a href="https://platform.openai.com/assistants" target="_blank" title="Get OpenAI Assistant ID">
              <i class="fas fa-link text-primary"></i>
            </a>
          </div>
          <input type="text" class="form-control" id="open-ai-asst-id" placeholder="Enter OpenAI Assistant ID">
        </div>

      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveUserKeys()">Save</button>
      </div>
    </div>
  </div>
</div>



{% endblock content %}

{% block js %}
<script>
    const firebaseConfig = {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: "",
            measurementId: ""
    };

    firebase.initializeApp(firebaseConfig)

    document.addEventListener("DOMContentLoaded", function () {

            const uploadBox = document.getElementById('upload-box');
            const fileInput = document.getElementById('file-input');

            

            uploadBox.addEventListener('click', function () {
                fileInput.click();
            });

            function encodeImageToBase64(file, maxSize) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();

                    reader.onload = () => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');

                            let width = img.width;
                            let height = img.height;
                            const maxDim = Math.max(width, height);

                            // Resize if necessary
                            if (maxDim > maxSize) {
                                const scaleFactor = maxSize / maxDim;
                                width = Math.round(width * scaleFactor);
                                height = Math.round(height * scaleFactor);
                                canvas.width = width;
                                canvas.height = height;
                                ctx.drawImage(img, 0, 0, width, height);
                            } else {
                                canvas.width = width;
                                canvas.height = height;
                                ctx.drawImage(img, 0, 0);
                            }

                            // Convert canvas to Base64
                            const base64String = canvas.toDataURL('image/png').split(',')[1];
                            resolve(base64String);
                        };
                        img.onerror = reject;
                        img.src = reader.result;
                    };

                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            fileInput.addEventListener('change', function () {
                const file = this.files[0];
                if (file) {
                    document.getElementById('loader').classList.remove('hidden');
                    encodeImageToBase64(file, 350).then(base64String => {
                        uploadImage(file, base64String)
                    }).catch(error => {
                        console.error('Error encoding image:', error);
                    });
                }
            });


            function uploadImage(file, base64String) {
                let storageRef = firebase.storage().ref("/images" + file.name)
                let uploadTask = storageRef.put(file)
                uploadTask.on("state_changed", (snapshot) => {
                    console.log(snapshot)
                }, (error) => {
                    console.log(error)
                }, () => {
                    uploadTask.snapshot.ref.getDownloadURL().then(async (url)=> {
                        const hashCode = await hashImageFromUrl(url)
                        saveImageToSession(base64String, url, hashCode);
                    })
                })
            }

            function saveImageToSession(base64String, firebaseUrl, hashCode) {
                fetch("{% url 'set_image_session' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: JSON.stringify({ image: base64String, firebaseUrl: firebaseUrl, hashCode: hashCode })
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loader').classList.add('hidden');
                    document.getElementById('file-input').value = '';

                    if (data.status === 'success') {
                        window.location.href = "/dashboard";
                    } else {
                        showUserConfig()
                    }
                    
                });
            }

    });

    function showUserConfig() {
        $('#userConfigModal').modal('show');
    }

    function closeUserConfig() {
        $('#userConfigModal').modal('hide');
    }

    function saveUserKeys() {
        const openai = document.getElementById("user-openai-key").value;
        const claude = document.getElementById("user-claude-key").value;
        const asstId = document.getElementById("open-ai-asst-id").value;

        if (!openai || !claude || !asstId) {
            alert("Both OpenAI, Claude API keys and Asst Id  are required.");
            return;
        }

        fetch("save-user-api-keys-session", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": '{{ csrf_token }}'
            },
            body: JSON.stringify({
                openai_key: openai,
                claude_key: claude,
                asst_id: asstId
            })
        }).then(res => res.json())
        .then(data => {
            alert("Keys saved!");
            closeUserConfig();
        });
    }

</script>
<script src="{% static 'js/image_helper.js' %}"></script>
{% endblock %}